<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Dayne EMA Scanner</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: #080810;
    color: #e2e8f0;
    font-family: 'Courier New', monospace;
    max-width: 430px;
    margin: 0 auto;
    min-height: 100vh;
  }
  .header {
    background: linear-gradient(160deg, #0c0c1e, #130f2a);
    padding: 18px 16px 14px;
    border-bottom: 1px solid #1a1a2e;
    position: sticky; top: 0; z-index: 100;
  }
  .header-row { display: flex; justify-content: space-between; align-items: center; }
  .header-label { font-size: 9px; color: #4a5568; letter-spacing: 3px; margin-bottom: 3px; }
  .header-title { font-size: 19px; font-weight: 800; color: #fff; }
  .header-title span.blue { color: #38bdf8; }
  .header-title span.purple { color: #a78bfa; }
  .badge { background: #38bdf808; border: 1px solid #38bdf830; border-radius: 10px; padding: 8px 12px; text-align: center; font-size: 10px; color: #38bdf8; }
  .last-scan { font-size: 9px; color: #374151; margin-top: 6px; }

  .controls {
    padding: 12px 14px;
    background: #0c0c18;
    border-bottom: 1px solid #1a1a2e;
  }
  .filter-row { display: flex; gap: 6px; margin-bottom: 10px; }
  .filter-btn {
    flex: 1; padding: 7px 2px; border-radius: 7px; border: 1px solid #1a1a2e;
    background: transparent; color: #4a5568; font-size: 10px; font-weight: 700;
    cursor: pointer; font-family: inherit; transition: all 0.2s;
  }
  .filter-btn.active { border-color: #38bdf8; background: #38bdf812; color: #38bdf8; }
  .btn-row { display: flex; gap: 8px; }
  .scan-btn {
    flex: 2; padding: 13px; border-radius: 10px; border: none;
    background: linear-gradient(135deg, #38bdf8, #a78bfa);
    color: #000; font-size: 13px; font-weight: 800;
    cursor: pointer; font-family: inherit;
  }
  .scan-btn:disabled { background: #1a1a2e; color: #4a5568; cursor: not-allowed; }
  .add-btn {
    flex: 1; padding: 13px; border-radius: 10px;
    border: 1px solid #38bdf830; background: transparent;
    color: #38bdf8; font-size: 12px; font-weight: 700;
    cursor: pointer; font-family: inherit;
  }
  .add-row { display: flex; gap: 6px; margin-top: 8px; }
  .add-input {
    flex: 1; padding: 10px 12px; border-radius: 8px;
    border: 1px solid #38bdf830; background: #080810;
    color: #e2e8f0; font-size: 13px; font-family: inherit; outline: none;
  }
  .add-confirm {
    padding: 10px 14px; border-radius: 8px; border: none;
    background: #38bdf8; color: #000; font-weight: 800;
    cursor: pointer; font-family: inherit;
  }
  .extra-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
  .extra-tag { font-size: 10px; padding: 2px 8px; background: #a78bfa18; border: 1px solid #a78bfa44; border-radius: 4px; color: #a78bfa; }
  .progress-wrap { margin-top: 10px; }
  .progress-label { font-size: 10px; color: #4a5568; margin-bottom: 4px; }
  .progress-label span { color: #38bdf8; }
  .progress-bar { background: #1a1a2e; border-radius: 4px; height: 3px; }
  .progress-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, #38bdf8, #a78bfa); transition: width 0.3s; }

  .results { padding: 12px 14px; }
  .empty { text-align: center; padding: 60px 20px; }
  .empty-icon { font-size: 52px; margin-bottom: 12px; }
  .empty-text { color: #374151; font-size: 13px; }
  .empty-sub { color: #1f2937; font-size: 11px; margin-top: 4px; }

  .card {
    background: #0e0e1c; border: 1px solid #1a1a2e;
    border-radius: 12px; padding: 14px; margin-bottom: 10px;
    position: relative; overflow: hidden;
  }
  .card.strong { border-color: #38bdf840; }
  .card-top-line { position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #38bdf8, #a78bfa); }
  .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
  .card-left {}
  .card-symbol-row { display: flex; align-items: center; gap: 8px; }
  .card-symbol { font-size: 17px; font-weight: 800; color: #f8fafc; }
  .dual-tag { display: inline-block; padding: 3px 8px; border-radius: 5px; font-size: 10px; font-weight: 700; color: #38bdf8; background: #38bdf812; border: 1px solid #38bdf840; }
  .card-price-row { margin-top: 3px; display: flex; align-items: center; gap: 8px; }
  .card-price { font-size: 14px; color: #94a3b8; }
  .card-change { font-size: 11px; font-weight: 700; }
  .card-tags { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
  .signal-tag { display: inline-block; padding: 3px 8px; border-radius: 5px; font-size: 10px; font-weight: 700; }
  .card-ema { display: flex; gap: 6px; margin-top: 10px; }
  .ema-box { flex: 1; background: #080810; border-radius: 7px; padding: 7px 9px; }
  .ema-title { font-size: 9px; color: #374151; margin-bottom: 4px; letter-spacing: 1px; }
  .ema-val { font-size: 10px; }
  .ema-gap { font-size: 10px; margin-top: 3px; }

  .error-box { margin-top: 8px; padding: 10px 12px; background: #1a0a0a; border: 1px solid #ef444430; border-radius: 8px; font-size: 10px; color: #64748b; }
  .legend { margin-top: 8px; padding: 12px; background: #0e0e1c; border-radius: 10px; border: 1px solid #1a1a2e; }
  .legend-title { font-size: 9px; color: #374151; margin-bottom: 6px; letter-spacing: 1px; }
  .legend-item { font-size: 10px; color: #4a5568; line-height: 1.9; }
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-row">
    <div>
      <div class="header-label">DAYNE Â· TRADING SYSTEM</div>
      <div class="header-title">EMA <span class="blue">5</span> / <span class="purple">20</span> Scanner</div>
    </div>
    <div class="badge">
      <div style="font-size:18px;line-height:1">ğŸ“¡</div>
      <div style="margin-top:3px">4H Â· 1D</div>
    </div>
  </div>
  <div class="last-scan" id="lastScan"></div>
</div>

<!-- CONTROLS -->
<div class="controls">
  <div class="filter-row">
    <button class="filter-btn active" onclick="setFilter('cross', this)">ğŸ”¥ å‰›ç©¿è¶Š</button>
    <button class="filter-btn" onclick="setFilter('above', this)">ğŸ“ˆ EMA5>20</button>
    <button class="filter-btn" onclick="setFilter('all', this)">å…¨éƒ¨</button>
  </div>
  <div class="btn-row">
    <button class="scan-btn" id="scanBtn" onclick="startScan()">ğŸš€ é–‹å§‹æƒæ</button>
    <button class="add-btn" onclick="toggleAdd()">ï¼‹ åŠ è‚¡ç¥¨</button>
  </div>
  <div class="add-row" id="addRow" style="display:none">
    <input class="add-input" id="addInput" placeholder="ä¾‹: IREN, CRWV, PLTR" onkeydown="if(event.key==='Enter')addStocks()">
    <button class="add-confirm" onclick="addStocks()">åŠ å…¥</button>
  </div>
  <div class="extra-tags" id="extraTags"></div>
  <div class="progress-wrap" id="progressWrap" style="display:none">
    <div class="progress-label">æ­£åœ¨æƒæï¼š<span id="progressSymbol"></span></div>
    <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
  </div>
</div>

<!-- RESULTS -->
<div class="results" id="results">
  <div class="empty">
    <div class="empty-icon">ğŸ“Š</div>
    <div class="empty-text">é»æ“Šã€Œé–‹å§‹æƒæã€</div>
    <div class="empty-sub" id="stockCount"></div>
  </div>
</div>

<script>
const API_KEY = "d6f6jb9r01qvn4o20qo0d6f6jb9r01qvn4o20qog";

let DEFAULT_STOCKS = [
  "NVDA","AAPL","MSFT","GOOGL","META","AMZN","TSLA","AMD",
  "CRWV","IREN","SMCI","AVGO","ARM","QCOM","MU",
  "RKLB","PLTR","COIN","MSTR","GLD","SLV"
];
let extraStocks = [];
let currentFilter = "cross";
let allResults = [];

function getAllStocks() {
  return [...new Set([...DEFAULT_STOCKS, ...extraStocks])];
}

document.getElementById("stockCount").textContent = `æƒæ ${getAllStocks().length} éš»è‚¡ç¥¨çš„ 4H + 1D EMA è¨Šè™Ÿ`;

function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderResults();
}

function toggleAdd() {
  const row = document.getElementById("addRow");
  row.style.display = row.style.display === "none" ? "flex" : "none";
}

function addStocks() {
  const val = document.getElementById("addInput").value.toUpperCase();
  const parsed = val.split(/[\s,]+/).map(s => s.trim()).filter(Boolean);
  extraStocks = [...new Set([...extraStocks, ...parsed])];
  document.getElementById("addInput").value = "";
  document.getElementById("addRow").style.display = "none";
  const tagsEl = document.getElementById("extraTags");
  tagsEl.innerHTML = extraStocks.map(s => `<span class="extra-tag">${s}</span>`).join("");
  document.getElementById("stockCount").textContent = `æƒæ ${getAllStocks().length} éš»è‚¡ç¥¨çš„ 4H + 1D EMA è¨Šè™Ÿ`;
}

function calcEMA(prices, period) {
  if (prices.length < period) return [];
  const k = 2 / (period + 1);
  let ema = prices.slice(0, period).reduce((a,b) => a+b, 0) / period;
  const series = [ema];
  for (let i = period; i < prices.length; i++) {
    ema = prices[i] * k + ema * (1 - k);
    series.push(ema);
  }
  return series;
}

function groupTo4H(closes) {
  const grouped = [];
  for (let i = 3; i < closes.length; i += 4) grouped.push(closes[i]);
  return grouped;
}

function analyzeEMA(closes) {
  if (!closes || closes.length < 22) return null;
  const ema5 = calcEMA(closes, 5);
  const ema20 = calcEMA(closes, 20);
  if (ema5.length < 2 || ema20.length < 2) return null;
  const n5 = ema5.length, n20 = ema20.length;
  const e5now = ema5[n5-1], e20now = ema20[n20-1];
  const e5prev = ema5[n5-2], e20prev = ema20[n20-2];
  let recentCross = e5prev <= e20prev && e5now > e20now;
  if (!recentCross) {
    for (let i = Math.max(1, n5-5); i < n5; i++) {
      const j = i - (n5 - n20);
      if (j >= 1 && ema5[i-1] <= ema20[j-1] && ema5[i] > ema20[j]) { recentCross = true; break; }
    }
  }
  return {
    recentCross,
    aboveNow: e5now > e20now,
    ema5: e5now,
    ema20: e20now,
    gap: ((e5now - e20now) / e20now * 100).toFixed(2)
  };
}

async function fetchCandles(symbol, resolution, from, to) {
  const url = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=${resolution}&from=${from}&to=${to}&token=${API_KEY}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data.s !== "ok" || !data.c) return null;
    return data.c;
  } catch { return null; }
}

async function fetchQuote(symbol) {
  try {
    const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEY}`);
    const data = await res.json();
    return { price: data.c, changeP: data.dp };
  } catch { return null; }
}

async function startScan() {
  const btn = document.getElementById("scanBtn");
  btn.disabled = true;
  document.getElementById("progressWrap").style.display = "block";
  allResults = [];
  const errors = [];
  const stocks = getAllStocks();
  const now = Math.floor(Date.now() / 1000);
  const from1H = now - 60 * 24 * 3600;
  const from1D = now - 400 * 24 * 3600;

  for (let i = 0; i < stocks.length; i++) {
    const symbol = stocks[i];
    const pct = Math.round((i+1) / stocks.length * 100);
    document.getElementById("progressSymbol").textContent = symbol;
    document.getElementById("progressFill").style.width = pct + "%";
    btn.textContent = `æƒæä¸­ ${pct}%`;

    try {
      const [closes1h, closes1d, quote] = await Promise.all([
        fetchCandles(symbol, "60", from1H, now),
        fetchCandles(symbol, "D", from1D, now),
        fetchQuote(symbol)
      ]);

      const r4h = closes1h ? analyzeEMA(groupTo4H(closes1h)) : null;
      const r1d = closes1d ? analyzeEMA(closes1d) : null;

      if (r4h?.recentCross || r4h?.aboveNow || r1d?.recentCross || r1d?.aboveNow) {
        const score = (r4h?.recentCross?4:0)+(r1d?.recentCross?4:0)+(r4h?.aboveNow?1:0)+(r1d?.aboveNow?1:0);
        allResults.push({ symbol, price: quote?.price, changeP: quote?.changeP, r4h, r1d, score });
      }
    } catch { errors.push(symbol); }

    await new Promise(r => setTimeout(r, 250));
  }

  allResults.sort((a,b) => b.score - a.score);
  document.getElementById("progressWrap").style.display = "none";
  btn.disabled = false;
  btn.textContent = "ğŸš€ é‡æ–°æƒæ";
  const now2 = new Date();
  document.getElementById("lastScan").textContent = `ä¸Šæ¬¡æƒæï¼š${now2.toLocaleTimeString('zh-HK')} Â· ${stocks.length} éš»`;
  renderResults(errors);
}

function signalTag(signal, timeframe) {
  if (!signal) return `<span class="signal-tag" style="color:#374151;background:#0e0e1c;border:1px solid #1a1a2e">${timeframe} â€”</span>`;
  if (signal.recentCross) return `<span class="signal-tag" style="color:${timeframe==='4H'?'#38bdf8':'#a78bfa'};background:${timeframe==='4H'?'#38bdf812':'#a78bfa12'};border:1px solid ${timeframe==='4H'?'#38bdf840':'#a78bfa40'}">${timeframe} ğŸ”¥ç©¿è¶Š</span>`;
  if (signal.aboveNow) return `<span class="signal-tag" style="color:#10b981;background:#10b98112;border:1px solid #10b98140">${timeframe} âœ…åœ¨ä¸Š</span>`;
  return `<span class="signal-tag" style="color:#374151;background:#0e0e1c;border:1px solid #1a1a2e">${timeframe} â€”</span>`;
}

function emaBox(r, timeframe, color) {
  if (!r) return "";
  return `
    <div class="ema-box">
      <div class="ema-title">${timeframe} EMA</div>
      <div class="ema-val" style="color:${color}">EMA5: ${r.ema5?.toFixed(2)}</div>
      <div class="ema-val" style="color:#64748b">EMA20: ${r.ema20?.toFixed(2)}</div>
      <div class="ema-gap" style="color:${parseFloat(r.gap)>0?'#10b981':'#ef4444'}">å·®è·: ${r.gap}%</div>
    </div>`;
}

function renderResults(errors) {
  const container = document.getElementById("results");
  const filtered = allResults.filter(r => {
    if (currentFilter === "cross") return r.r4h?.recentCross || r.r1d?.recentCross;
    if (currentFilter === "above") return r.r4h?.aboveNow || r.r1d?.aboveNow;
    return true;
  });

  if (filtered.length === 0) {
    container.innerHTML = `<div class="empty"><div class="empty-icon">ğŸ”</div><div class="empty-text">æ­¤ç¯©é¸æ¢ä»¶æš«ç„¡çµæœ</div><div class="empty-sub">è©¦è©¦ã€Œå…¨éƒ¨ã€</div></div>`;
    return;
  }

  let html = filtered.map(r => {
    const both = r.r4h?.recentCross && r.r1d?.recentCross;
    const chgColor = !r.changeP ? "#64748b" : r.changeP >= 0 ? "#10b981" : "#ef4444";
    const chgText = r.changeP != null ? `<span class="card-change" style="color:${chgColor}">${r.changeP>=0?'+':''}${r.changeP?.toFixed(2)}%</span>` : "";
    return `
      <div class="card ${both?'strong':''}">
        ${both ? '<div class="card-top-line"></div>' : ''}
        <div class="card-header">
          <div class="card-left">
            <div class="card-symbol-row">
              <span class="card-symbol">${r.symbol}</span>
              ${both ? '<span class="dual-tag">ğŸ”¥ é›™é‡è¨Šè™Ÿ</span>' : ''}
            </div>
            <div class="card-price-row">
              <span class="card-price">$${r.price ? r.price.toFixed(2) : 'â€”'}</span>
              ${chgText}
            </div>
          </div>
          <div class="card-tags">
            ${signalTag(r.r4h, '4H')}
            ${signalTag(r.r1d, '1D')}
          </div>
        </div>
        <div class="card-ema">
          ${emaBox(r.r4h, '4H', '#38bdf8')}
          ${emaBox(r.r1d, '1D', '#a78bfa')}
        </div>
      </div>`;
  }).join("");

  if (errors && errors.length > 0) {
    html += `<div class="error-box">ç„¡æ³•ç²å–ï¼š${errors.join(", ")}</div>`;
  }

  html += `
    <div class="legend">
      <div class="legend-title">åœ–ä¾‹</div>
      <div class="legend-item">
        <span style="color:#38bdf8">ğŸ”¥ ç©¿è¶Š</span> = EMA5 å‰›å‘ä¸Šç©¿è¶Š EMA20<br>
        <span style="color:#10b981">âœ… åœ¨ä¸Š</span> = EMA5 å·²åœ¨ EMA20 ä¸Šæ–¹<br>
        <span style="color:#a78bfa">ğŸ”¥ é›™é‡è¨Šè™Ÿ</span> = 4H + 1D åŒæ™‚ç©¿è¶Š
      </div>
    </div>
    <div style="height:30px"></div>`;

  container.innerHTML = html;
}
</script>
</body>
</html>
